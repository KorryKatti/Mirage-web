<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MIRAGE Interface // V-0.0.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="scanlines">
  <!-- Mobile menu toggle button (hidden on desktop) -->
  <button class="menu-toggle" id="menuToggle" style="display:none;">‚ò∞</button>
  
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <img src="img/logo.png" height="100px" width="100px" alt="MIRAGE Logo" />
    </div>
    <div class="user-info">
      <p>Welcome, <span id="username">User</span></p>
      <p class="status-indicator">‚óâ ONLINE</p>
    </div>
    <nav>
      <ul>
        <li><a href="./index.html"><span class="nav-icon">‚åÇ</span> Home</a></li>
        <li><a href="./room.html" class="active"><span class="nav-icon">üí¨</span> Room</a></li>
        <li><a id="profileLink"><span class="nav-icon">üë§</span> Profile</a></li>
        <li><a id="inboxLink"><span class="nav-icon">üìß</span> Inbox <span id="inboxCount" class="inbox-badge" style="display: none;"></span></a></li>
      </ul>
    </nav>
    
    <div class="room-selector">
      <div class="section-header">CHANNELS <span class="expand-icon" id="toggleRooms">‚ñº</span></div>
      <ul id="roomList" class="room-list">
        <!-- Rooms will be populated here -->
      </ul>
    </div>
    <div class="sidebar-footer">
      <div class="system-status">
        <span class="sys-label">SYS : </span>
        <span class="status-indicator"></span>
        <span class="status-text">NOMINAL</span>
      </div>
      <div class="version-info">v0.0.4-BETA</div>
    </div>
  </div>

  <div class="header" id="headerText">üß† MIRAGE Interface v0.0.4-BETA // Loading...</div>
  <div class="chat-box" id="chat">
    <!-- messages will populate here -->
  </div>

  <div class="input-box">
    <input type="text" id="input" placeholder="Enter message..." />
    <button onclick="sendMsg()">Send</button>
    <button class="file-upload-btn" onclick="triggerFileUpload()">
      üìé File
      <input type="file" id="fileInput" onchange="handleFileUpload()" />
    </button>
  </div>

  <div class="divergence" onclick="logout()">log out</div>

  <!-- Join Room Modal -->
  <div id="joinRoomModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeJoinModal()">&times;</span>
      <h3>Join Channel</h3>
      <input type="text" id="joinRoomName" placeholder="Channel name" />
      <button onclick="joinRoom()">Join</button>
      <div id="joinError" class="error-message"></div>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div id="createRoomModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCreateModal()">&times;</span>
      <h3>Create Channel</h3>
      <input type="text" id="createRoomName" placeholder="Channel name" />
      <label>
        <input type="checkbox" id="isPrivate" /> Private Channel
      </label>
      <button onclick="createRoom()">Create</button>
      <div id="createError" class="error-message"></div>
    </div>
  </div>

  <!-- Inbox Modal -->
  <div id="inboxModal" class="modal">
    <div class="modal-content inbox-modal">
      <div class="modal-header">
        <h3>üìß Inbox Messages</h3>
        <div class="modal-controls">
          <button onclick="showSendMessageModal()" class="send-btn">Send Message</button>
          <span class="close" onclick="closeInboxModal()">&times;</span>
        </div>
      </div>
      <div id="inboxMessages" class="inbox-messages">
        <!-- Inbox messages will be populated here -->
      </div>
    </div>
  </div>

  <!-- Send Message Modal -->
  <div id="sendMessageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSendMessageModal()">&times;</span>
      <h3>Send Message</h3>
      <input type="text" id="recipientUsername" placeholder="Recipient username" />
      <textarea id="messageText" placeholder="Enter your message..." rows="4"></textarea>
      <button onclick="sendInboxMessage()">Send</button>
      <div id="sendError" class="error-message"></div>
    </div>
  </div>

  <!-- Download Warning Modal -->
  <div id="downloadWarningModal" class="modal warning-modal">
    <div class="modal-content">
      <span class="close" onclick="closeDownloadWarning()">&times;</span>
      <div class="warning-header">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <h3>Download Warning</h3>
      </div>
      <div class="warning-content">
        <p>You are about to download a file from an external source. Please ensure you trust the sender before proceeding.</p>
        <div class="file-info" id="downloadFileInfo">
          <!-- File info will be populated here -->
        </div>
        <div class="disable-warnings">
          <input type="checkbox" id="disableWarnings" />
          <label for="disableWarnings">Don't show this warning again</label>
        </div>
      </div>
      <div class="warning-buttons">
        <button class="btn-cancel" onclick="closeDownloadWarning()">Cancel</button>
        <button class="btn-proceed" onclick="proceedDownload()">Download</button>
      </div>
    </div>
  </div>

  <script>
let server_url = '';

fetch('settings.json')
  .then(res => res.json())
  .then(settings => {
    if (settings.server_url) {
      server_url = settings.server_url;
    } else {
      alert('server_url not found in settings.json');
    }
  })
  .catch(() => {
    alert('Failed to load settings.json');
  });

const chatBox = document.getElementById('chat');
const input = document.getElementById('input');

const username = localStorage.getItem('user');
const token = localStorage.getItem('token');

let currentRoomId = null;
let currentRoomName = 'Loading...';
let availableRooms = [];
let pendingDownloadUrl = null;

// Check if download warnings are disabled
let downloadWarningsDisabled = localStorage.getItem('downloadWarningsDisabled') === 'true';

if (!username || !token) {
  alert('You are not logged in.');
  window.location.href = './index.html';
}

window.onload = function() {
  const user = localStorage.getItem('user');

  if (!user) {
    alert("You are not logged in. Redirecting to homepage");
    window.location.href = './index.html';
  } else {
    document.getElementById('username').textContent = user;
    const profileLink = document.getElementById('profileLink');
    if (profileLink) {
      profileLink.href = `./userprofile.html?user=${encodeURIComponent(user)}`;
    }
    
    // Setup inbox link
    const inboxLink = document.getElementById('inboxLink');
    if (inboxLink) {
      inboxLink.addEventListener('click', showInboxModal);
      inboxLink.style.cursor = 'pointer';
    }
    
    loadRooms();
    loadInboxCount();
  }
};

function loadRooms() {
  // wait 1.22 seconds before loading rooms
  setTimeout(() => {
    fetchRooms();
  }, 1220);
  fetch(`${server_url}/api/rooms`, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.rooms) {
      availableRooms = data.rooms;
      populateRoomList();
      
      // Auto-select first joined room or first available room
      const joinedRoom = data.rooms.find(r => r.joined);
      if (joinedRoom) {
        selectRoom(joinedRoom.room_id, joinedRoom.name);
      } else if (data.rooms.length > 0) {
        // Try to join the first available room automatically
        const firstRoom = data.rooms[0];
        joinExistingRoom(firstRoom.name, () => {
          selectRoom(firstRoom.room_id, firstRoom.name);
        });
      }
    }
  })
  .catch(err => {
    console.error('Failed to load rooms:', err);
  });
}

function populateRoomList() {
  const roomList = document.getElementById('roomList');
  roomList.innerHTML = '';
  
  availableRooms.forEach(room => {
    const li = document.createElement('li');
    li.className = 'room';
    li.setAttribute('data-room-id', room.room_id);
    li.setAttribute('data-room-name', room.name);
    
    const icon = room.joined ? '‚óâ' : '‚óé';
    const joinedClass = room.joined ? '' : ' not-joined';
    
        li.innerHTML = `<span class="room-icon">${icon}</span> ${room.name}`;
    li.className += joinedClass;
    
    li.addEventListener('click', () => {
      if (room.joined) {
        selectRoom(room.room_id, room.name);
      } else {
        joinExistingRoom(room.name, () => {
          room.joined = true;
          selectRoom(room.room_id, room.name);
          populateRoomList(); // Refresh the list
        });
      }
    });
    
    roomList.appendChild(li);
  });
  
  // Add "Join Channel" button
  const joinLi = document.createElement('li');
  joinLi.className = 'room add-room';
  joinLi.innerHTML = '<span class="room-icon">+</span> Join Channel';
  joinLi.addEventListener('click', showJoinRoomModal);
  roomList.appendChild(joinLi);
  
  // Add "Create Channel" button
  const createLi = document.createElement('li');
  createLi.className = 'room add-room';
  createLi.innerHTML = '<span class="room-icon">+</span> Create Channel';
  createLi.addEventListener('click', showCreateRoomModal);
  roomList.appendChild(createLi);
}

function checkServerStatus() {
  const startTime = Date.now();
  
  fetch(`${server_url}/api/ping`)
    .then(res => {
      const endTime = Date.now();
      const responseTime = endTime - startTime;
      
      const statusDiv = document.querySelector('.system-status');
      const statusIndicator = document.querySelector('.status-indicator');
      const statusText = document.querySelector('.status-text');
      
      if (res.ok && res.status === 200) {
        statusDiv.className = 'system-status status-nominal';
        statusText.textContent = 'NOMINAL';
        statusIndicator.textContent = '‚óâ';
        statusIndicator.style.color = '#00ff00';
        
        if (responseTime > 500) {
          statusDiv.className = 'system-status status-slow';
          statusText.textContent = 'SLOW';
          statusIndicator.style.color = '#ffaa00';
        }
      } else {
        statusDiv.className = 'system-status status-offline';
        statusText.textContent = 'OFFLINE';
        statusIndicator.textContent = '‚óâ';
        statusIndicator.style.color = '#ff0000';
      }
    })
    .catch(err => {
      console.error('Failed to check server status:', err);
      const statusDiv = document.querySelector('.system-status');
      const statusIndicator = document.querySelector('.status-indicator');
      const statusText = document.querySelector('.status-text');
      
      statusDiv.className = 'system-status status-offline';
      statusText.textContent = 'OFFLINE';
      statusIndicator.textContent = '‚óâ';
      statusIndicator.style.color = '#ff0000';
    });
}

// Check server status periodically
setInterval(checkServerStatus, 5000); // Check every 5 seconds
checkServerStatus(); // Initial check


function selectRoom(roomId, roomName) {
  currentRoomId = roomId;
  currentRoomName = roomName;
  
  // Update active room in UI
  document.querySelectorAll('.room').forEach(r => r.classList.remove('active'));
  const activeRoom = document.querySelector(`[data-room-id="${roomId}"]`);
  if (activeRoom) {
    activeRoom.classList.add('active');
  }
  
  // Update header
  document.getElementById('headerText').textContent = `üß† MIRAGE Interface v0.0.4-BETA // ${roomName}`;
  
  // Load messages for this room
  fetchMessages();
}

function joinExistingRoom(roomName, callback) {
  fetch(`${server_url}/api/join_room`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({ name: roomName })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      console.log(data.message);
      if (callback) callback();
    } else {
      console.error('Failed to join room:', data.error);
    }
  })
  .catch(err => {
    console.error('Error joining room:', err);
  });
}

function sendMsg() {
  const message = input.value.trim();
  if (!message || !currentRoomId) return;

  fetch(`${server_url}/api/send_room_message`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({ 
      room_id: currentRoomId, 
      message: message 
    })
  }).then(res => {
    if (!res.ok) console.error('flask rejected the message');
  }).catch(err => {
    console.error('server is ghosting:', err);
  });

  input.value = '';
}

function escapeHTML(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function parseMarkdown(text) {
  text = escapeHTML(text);
  return text
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/_(.*?)_/g, '<i>$1</i>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
    .replace(/^- (.*$)/gm, '<li>$1</li>');
}

function fetchMessages() {
  if (!currentRoomId) return;

  fetch(`${server_url}/api/get_room_messages?room_id=${currentRoomId}`, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.messages) return;

    chatBox.innerHTML = '';
    data.messages.forEach(m => {
      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.innerHTML = `<span class="msg-user"><a href="./userprofile.html?user=${encodeURIComponent(m.username)}" style="color: #ff004c;">~${m.username}</a>:</span> <span class="msg-text">${parseMarkdown(m.message)}</span>`;
      chatBox.appendChild(msg);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  })
  .catch(err => {
    console.error('Failed to fetch messages:', err);
  });
}

input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMsg();
});

// Pull new messages every 3s
setInterval(fetchMessages, 3000);

setTimeout(loadRooms, 1000);

// Check inbox count every 30s
setInterval(loadInboxCount, 30000);

function logout() {
  fetch(`${server_url}/api/logout`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ token })
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(data => {
        throw new Error(data.error || 'Logout failed');
      });
    }
    return res.json();
  })
  .then(data => {
    console.log(data.message);
    localStorage.removeItem('user');
    localStorage.removeItem('token');
    window.location.href = './index.html';
  })
  .catch(err => {
    console.error('Logout failed:', err.message);
  });
}

// Modal functions
function showJoinRoomModal() {
  document.getElementById('joinRoomModal').style.display = 'block';
  document.getElementById('joinError').textContent = '';
}

function closeJoinModal() {
  document.getElementById('joinRoomModal').style.display = 'none';
}

function showCreateRoomModal() {
  document.getElementById('createRoomModal').style.display = 'block';
  document.getElementById('createError').textContent = '';
}

function closeCreateModal() {
  document.getElementById('createRoomModal').style.display = 'none';
}

// Inbox functions
function loadInboxCount() {
  fetch(`${server_url}/api/inbox_count`, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then(res => res.json())
  .then(data => {
    const countBadge = document.getElementById('inboxCount');
    if (data.inbox_count && data.inbox_count > 0) {
      countBadge.textContent = data.inbox_count;
      countBadge.style.display = 'inline';
    } else {
      countBadge.style.display = 'none';
    }
  })
  .catch(err => {
    console.error('Failed to load inbox count:', err);
  });
}

function showInboxModal() {
  document.getElementById('inboxModal').style.display = 'block';
  loadInboxMessages();
}

function closeInboxModal() {
  document.getElementById('inboxModal').style.display = 'none';
}

function loadInboxMessages() {
  fetch(`${server_url}/api/inbox`, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then(res => res.json())
  .then(data => {
    const messagesContainer = document.getElementById('inboxMessages');
    messagesContainer.innerHTML = '';
    
    if (!data.messages || data.messages.length === 0) {
      messagesContainer.innerHTML = '<div class="no-messages">No messages found</div>';
      return;
    }
    
    data.messages.forEach(msg => {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'inbox-message';
      messageDiv.innerHTML = `
        <div class="message-header">
          <img src="${msg.avatar_url}" class="sender-avatar" alt="Avatar" />
          <div class="message-info">
            <span class="sender-name">~${msg.sender}</span>
            <span class="message-time">${formatTime(msg.created_at)}</span>
          </div>
          <button onclick="deleteInboxMessage(${msg.id})" class="delete-btn">√ó</button>
        </div>
        <div class="message-content">${parseMarkdown(msg.message)}</div>
      `;
      messagesContainer.appendChild(messageDiv);
    });
  })
  .catch(err => {
    console.error('Failed to load inbox messages:', err);
    document.getElementById('inboxMessages').innerHTML = '<div class="error-message">Failed to load messages</div>';
  });
}

function deleteInboxMessage(messageId) {
  if (!confirm('Are you sure you want to delete this message?')) return;
  
  fetch(`${server_url}/api/delete_inbox_message`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({ message_id: messageId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      loadInboxMessages(); // Refresh messages
      loadInboxCount(); // Update count
    } else {
      alert('Failed to delete message: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    console.error('Failed to delete message:', err);
    alert('Failed to delete message');
  });
}

function showSendMessageModal() {
  document.getElementById('sendMessageModal').style.display = 'block';
  document.getElementById('sendError').textContent = '';
}

function closeSendMessageModal() {
  document.getElementById('sendMessageModal').style.display = 'none';
  document.getElementById('recipientUsername').value = '';
  document.getElementById('messageText').value = '';
}

function sendInboxMessage() {
  const recipient = document.getElementById('recipientUsername').value.trim();
  const message = document.getElementById('messageText').value.trim();
  const errorDiv = document.getElementById('sendError');
  
  if (!recipient || !message) {
    errorDiv.textContent = 'Please fill in both recipient and message';
    return;
  }
  
  fetch(`${server_url}/api/send_inbox_message`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({
      recipient: recipient,
      message: message
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      closeSendMessageModal();
      alert('Message sent successfully!');
    } else {
      errorDiv.textContent = data.error || 'Failed to send message';
    }
  })
  .catch(err => {
    console.error('Failed to send message:', err);
    errorDiv.textContent = 'Failed to send message';
  });
}

function formatTime(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleString();
}

function joinRoom() {
  const roomName = document.getElementById('joinRoomName').value.trim();
  const errorDiv = document.getElementById('joinError');
  
  if (!roomName) {
    errorDiv.textContent = 'Please enter a room name';
    return;
  }

  fetch(`${server_url}/api/join_room`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({ name: roomName })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      closeJoinModal();
      loadRooms(); // Refresh room list
      document.getElementById('joinRoomName').value = '';
    } else {
      errorDiv.textContent = data.error || 'Failed to join room';
    }
  })
  .catch(err => {
    errorDiv.textContent = 'Error joining room';
    console.error('Error:', err);
  });
}

function createRoom() {
  const roomName = document.getElementById('createRoomName').value.trim();
  const isPrivate = document.getElementById('isPrivate').checked;
  const errorDiv = document.getElementById('createError');
  
  if (!roomName) {
    errorDiv.textContent = 'Please enter a room name';
    return;
  }

  fetch(`${server_url}/api/create_room`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': token
    },
    body: JSON.stringify({ 
      room_name: roomName,
      is_private: isPrivate ? 1 : 0
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      closeCreateModal();
      loadRooms(); // Refresh room list
      document.getElementById('createRoomName').value = '';
      document.getElementById('isPrivate').checked = false;
    } else {
      errorDiv.textContent = data.error || 'Failed to create room';
    }
  })
  .catch(err => {
    errorDiv.textContent = 'Error creating room';
    console.error('Error:', err);
  });
}

// Add this to your script section
function fetchRooms() {
  fetch(`${server_url}/api/rooms`, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.rooms) {
      availableRooms = data.rooms;
      populateRoomList();
    }
  })
  .catch(err => {
    console.error('Failed to fetch rooms:', err);
  });
}

function triggerFileUpload() {
  document.getElementById('fileInput').click();
}

function handleFileUpload() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', currentRoomId);

    fetch(`${server_url}/api/upload_file`, {
        method: 'POST',
        headers: {
            'Authorization': token
        },
        body: formData
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(err => {
                throw new Error(err.error || `Network response was not ok: ${res.status} ${res.statusText}`);
            });
        }
        return res.json();
    })
    .then(data => {
        if (data.error) {
            console.error('Upload failed:', data.error);
            alert('Failed to upload file: ' + data.error);
            return;
        }
        if (data.file_url) {
            console.log('File uploaded successfully:', data.file_url);
            const message = `[File] ${data.file_url}`;
            sendMsg(); // Call sendMsg with the file URL
        }
    })
    .catch(err => {
        console.error('Failed to upload file:', err);
        alert('Failed to upload file: ' + err.message);
    });
}
// Mobile sidebar toggle functionality
document.addEventListener('DOMContentLoaded', function() {
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');
  const toggleRooms = document.getElementById('toggleRooms');
  const roomList = document.getElementById('roomList');
  
  // Check if we're on mobile and show the toggle button if needed
  function checkMobile() {
    if (window.innerWidth <= 768) {
      menuToggle.style.display = 'block';
    } else {
      menuToggle.style.display = 'none';
      sidebar.classList.remove('active');
    }
  }
  
  // Toggle sidebar visibility on mobile
  menuToggle.addEventListener('click', function() {
    sidebar.classList.toggle('active');
  });
  
  // Toggle room list visibility
  toggleRooms.addEventListener('click', function() {
    roomList.classList.toggle('collapsed');
    toggleRooms.classList.toggle('collapsed');
  });
  
  // Check on load and on resize
  checkMobile();
  window.addEventListener('resize', checkMobile);
});

// Close modals when clicking outside
window.onclick = function(event) {
  const joinModal = document.getElementById('joinRoomModal');
  const createModal = document.getElementById('createRoomModal');
  const inboxModal = document.getElementById('inboxModal');
  const sendModal = document.getElementById('sendMessageModal');
  
  if (event.target === joinModal) {
    closeJoinModal();
  }
  if (event.target === createModal) {
    closeCreateModal();
  }
  if (event.target === inboxModal) {
    closeInboxModal();
  }
  if (event.target === sendModal) {
    closeSendMessageModal();
  }
}
  </script>
</body>
</html>